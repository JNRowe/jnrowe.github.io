<?xml version='1.0' encoding='UTF-8'?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>https://jnrowe.github.io/</id>
  <title>JNRowe - Posts tagged git</title>
  <updated>2022-03-11T11:45:56.390003+00:00</updated>
  <link href="https://jnrowe.github.io/"/>
  <link href="https://jnrowe.github.io/blog/tag/git/atom.xml" rel="self"/>
  <generator uri="https://ablog.readthedocs.org/" version="0.10.23">ABlog</generator>
  <subtitle>Ramblings of a tired mind</subtitle>
  <entry>
    <id>https://jnrowe.github.io/articles/tips/Context_aware_diffs_with_git.html</id>
    <title>Context aware diffs with git</title>
    <updated>2009-09-29T00:00:00+01:00</updated>
    <author>
      <name>James Rowe</name>
    </author>
    <content type="html">&lt;section id="context-aware-diffs-with-git"&gt;

&lt;p&gt;Earlier this week Luke Cox asked in response to a patch I sent:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div&gt;&lt;p&gt;What version of &lt;a class="reference external" href="http://www.git-scm.com/"&gt;git&lt;/a&gt; are you using?  Mine doesn’t seem to produce the right
location output for &lt;strong class="command"&gt;format-patch&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;strong class="command"&gt;git&lt;/strong&gt;, by default, displays a &lt;a class="reference external" href="http://www.gnu.org/software/diffutils/manual/html_node/C-Function-Headings.html"&gt;function name in the hunk header&lt;/a&gt; of
its &lt;strong class="command"&gt;diff&lt;/strong&gt; output.  It produces some really nice output for certain
languages, but out of the box it doesn’t display nice information for all the
file formats you may use.&lt;/p&gt;
&lt;div class="highlight-diff notranslate"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gh"&gt;diff --git 1/config/dconf/user.ini 2/config/dconf/user.ini&lt;/span&gt;
&lt;span class="gh"&gt;index d4bf8a0..5559f9f 100644&lt;/span&gt;
&lt;span class="gd"&gt;--- 1/config/dconf/user.ini&lt;/span&gt;
&lt;span class="gi"&gt;+++ 2/config/dconf/user.ini&lt;/span&gt;
&lt;span class="gu"&gt;@@ -5,5 +5,5 @@ org/gtk/settings/file-chooser&lt;/span&gt;
 sort-column=&amp;#39;name&amp;#39;
 show-size-column=true
 startup-mode=&amp;#39;cwd&amp;#39;
&lt;span class="gd"&gt;-show-hidden=false&lt;/span&gt;
&lt;span class="gi"&gt;+show-hidden=true&lt;/span&gt;
 sort-directories-first=true
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The patch I sent Luke included a significant change to an &lt;a class="reference external" href="http://www.cloanto.com/specs/ini.html"&gt;.ini&lt;/a&gt; format file,
including some mostly accurate location information in the hunk header as in
the example above.  It wasn’t because I use a newer version of &lt;strong class="command"&gt;git&lt;/strong&gt;,
just that I’ve set it up to use different matchers for different files.  In my
&lt;code class="file docutils literal notranslate"&gt;&lt;span class="pre"&gt;~/.config/git/config&lt;/span&gt;&lt;/code&gt; I have the following snippet to use better
function names in &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;ini&lt;/span&gt;&lt;/code&gt; and &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;adr&lt;/span&gt;&lt;/code&gt; files:&lt;/p&gt;
&lt;div class="highlight-ini notranslate"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[diff &amp;quot;ini&amp;quot;]&lt;/span&gt;
    &lt;span class="na"&gt;funcname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;^\\[\\(.*\\)\\]$&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;[diff &amp;quot;adr&amp;quot;]&lt;/span&gt;
    &lt;span class="na"&gt;funcname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;^#.*$&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="admonition warning"&gt;
&lt;p class="admonition-title"&gt;Warning&lt;/p&gt;
&lt;p&gt;Be sure to escape backslashes, as the config parser will eat a single
backslash before it is even seen by the diff driver.  For the full details
on the format, see &lt;em class="manpage"&gt;gitattributes(7)&lt;/em&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;And, to enable them you must tell &lt;strong class="command"&gt;git&lt;/strong&gt; which files to use the new
matchers with by editing the &lt;code class="file docutils literal notranslate"&gt;&lt;span class="pre"&gt;.gitattributes&lt;/span&gt;&lt;/code&gt; file:&lt;/p&gt;
&lt;div class="highlight-text notranslate"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;*.ini diff=ini
*.adr diff=adr
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;funcname&lt;/span&gt;&lt;/code&gt; values are simple &lt;abbr title="Regular Expression"&gt;RegEx&lt;/abbr&gt; to search for, so in the &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;ini&lt;/span&gt;&lt;/code&gt;
example it is searching for a line that begins with a &lt;code class="regexp docutils literal notranslate"&gt;&lt;span class="pre"&gt;[&lt;/span&gt;&lt;/code&gt; and ends with
a &lt;code class="regexp docutils literal notranslate"&gt;&lt;span class="pre"&gt;]&lt;/span&gt;&lt;/code&gt; as these are the common section headers.  And the &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;adr&lt;/span&gt;&lt;/code&gt; matcher
just specifies a line that begins with a &lt;code class="regexp docutils literal notranslate"&gt;&lt;span class="pre"&gt;#&lt;/span&gt;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It is important to match the entire string or to use grouping, as it is the
matched content that is used in the diff hunk’s output.  As can be seen in the
&lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;ini&lt;/span&gt;&lt;/code&gt; example, I group only the text between &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;[&lt;/span&gt;&lt;/code&gt; and &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;]&lt;/span&gt;&lt;/code&gt; so that the
brackets aren’t included in the header.&lt;/p&gt;
&lt;/section&gt;
</content>
    <link href="https://jnrowe.github.io/articles/tips/Context_aware_diffs_with_git.html" rel="alternate"/>
    <summary>Earlier this week Luke Cox asked in response to a patch I sent:</summary>
    <category term="git" label="git"/>
    <published>2009-09-29T00:00:00+01:00</published>
  </entry>
  <entry>
    <id>https://jnrowe.github.io/articles/tips/Zsh_and_the_vcs.html</id>
    <title>Zsh and the VCS</title>
    <updated>2009-10-28T00:00:00+00:00</updated>
    <author>
      <name>James Rowe</name>
    </author>
    <content type="html">&lt;section id="zsh-and-the-vcs"&gt;

&lt;img alt="Git prompt screenshot" class="align-right" src="../../_images/2009-10-28-git_prompt.png" /&gt;
&lt;p&gt;I’ve recently switched to &lt;a class="reference external" href="http://www.zsh.org/"&gt;Zsh&lt;/a&gt; as my login shell after
9 years of using &lt;a class="reference external" href="http://cnswww.cns.cwru.edu/~chet/bash/bashtop.html"&gt;bash&lt;/a&gt;, and for no particularly good reason either as they’re
both great interactive shells.  I guess all the &lt;em&gt;Kool Kids&lt;/em&gt; are doing it, and
I’m just playing catchup.  The one side effect of that is I’m now scribbling
tips about &lt;strong class="command"&gt;zsh&lt;/strong&gt; too…&lt;/p&gt;
&lt;p&gt;In a screenshot I posted in our bugtracker — that was considerably less staged
than the example above — one of my more visual hunks of &lt;strong class="command"&gt;zsh&lt;/strong&gt;
configuration was visible, leading to the following question from Dan Wilson:&lt;/p&gt;
&lt;blockquote&gt;
&lt;div&gt;&lt;p&gt;Okay, ‘fess time.  How do you get &lt;strong class="command"&gt;git&lt;/strong&gt; branch names in the
prompt?  How do you make the funky arrows show repo status?&lt;/p&gt;
&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Firstly, I use &lt;a class="reference external" href="http://github.com/robbyrussell/oh-my-zsh"&gt;oh-my-zsh&lt;/a&gt; which is an excellent basis for &lt;strong class="command"&gt;zsh&lt;/strong&gt;
configuration files.  My prompt settings work within that framework, although
they could be converted to work with &lt;em&gt;plain&lt;/em&gt; &lt;strong class="command"&gt;zsh&lt;/strong&gt; if you have the
inclination.&lt;/p&gt;
&lt;p&gt;If you want to see my entire “theme” file you can &lt;a class="reference external" href="http://github.com/JNRowe/oh-my-zsh"&gt;clone my fork&lt;/a&gt; and look at
&lt;a class="reference external" href="http://github.com/JNRowe/oh-my-zsh/blob/master/themes/jnrowe.zsh-theme"&gt;oh-my-zsh/themes/jnrowe.zsh-theme&lt;/a&gt;.&lt;/p&gt;
&lt;section id="branch-names"&gt;
&lt;h2&gt;Branch names&lt;/h2&gt;
&lt;p&gt;&lt;strong class="command"&gt;zsh&lt;/strong&gt; comes with some neat &lt;abbr title="Version Control System"&gt;VCS&lt;/abbr&gt; integration, that is exceptionally
&lt;a class="reference external" href="http://zsh.sourceforge.net/Doc/Release/User-Contributions.html#SEC273"&gt;documented&lt;/a&gt; in the manual.  I use that code to enable branch names in my
prompt, I use it directly instead of the code in &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;oh-my-zsh&lt;/span&gt;&lt;/code&gt; that handles
&lt;strong class="command"&gt;git&lt;/strong&gt; status because it doesn’t do what I want [yet].  I use a format
that matches the default(&lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;robbyrussell&lt;/span&gt;&lt;/code&gt;) theme in &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;oh-my-zsh&lt;/span&gt;&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight-zsh notranslate"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;autoload -Uz vcs_info

&lt;span class="c1"&gt;# See the documentation for the format string definition&lt;/span&gt;
&lt;span class="c1"&gt;# This generates a fancy coloured string with $vcs:($branch)&lt;/span&gt;
zstyle &lt;span class="s1"&gt;&amp;#39;:vcs_info:*&amp;#39;&lt;/span&gt; formats &lt;span class="s1"&gt;&amp;#39;%F{2}%s%F{7}:%F{2}(%F{1}%b%F{2})%f &amp;#39;&lt;/span&gt;
zstyle &lt;span class="s1"&gt;&amp;#39;:vcs_info:*&amp;#39;&lt;/span&gt; &lt;span class="nb"&gt;enable&lt;/span&gt; git
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Once we’ve configured &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;vcs_info&lt;/span&gt;&lt;/code&gt; we just need to include
&lt;span class="target" id="index-0"&gt;&lt;/span&gt;&lt;code class="xref std std-envvar docutils literal notranslate"&gt;&lt;span class="pre"&gt;${vcs_info_msg_0_}&lt;/span&gt;&lt;/code&gt; somewhere in our prompt to display the &lt;abbr title="Version Control System"&gt;VCS&lt;/abbr&gt; and
current branch name.&lt;/p&gt;
&lt;p&gt;&lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;vcs_info&lt;/span&gt;&lt;/code&gt; works quite well, and supports many different systems(both common
and uncommon).  As the code snippet shows I enable support for &lt;a class="reference external" href="http://www.git-scm.com/"&gt;git&lt;/a&gt; exclusively.
I’ve used it with &lt;a class="reference external" href="http://www.selenic.com/mercurial/"&gt;mercurial&lt;/a&gt; too, and it works well.  &lt;a class="reference external" href="http://darcs.net"&gt;darcs&lt;/a&gt; also appears to
work well, but it isn’t a system I use often enough to have tested it
thoroughly.&lt;/p&gt;
&lt;p&gt;I tested &lt;strong class="command"&gt;bzr&lt;/strong&gt; support while writing this but it is totally unusable
because of just how painfully slow &lt;strong class="command"&gt;bzr&lt;/strong&gt; is.  On my system it adds
close to one and half seconds to every prompt display, although that could be
improved if I wasn’t using conservative &lt;abbr title="Central Processing Unit"&gt;CPU&lt;/abbr&gt;
scaling to save power.  As a comparison the &lt;strong class="command"&gt;git&lt;/strong&gt; info takes less than
a tenth of a second to calculate on the same system, and &lt;strong class="command"&gt;mercurial&lt;/strong&gt;
around three times that which is most definitely still usable.&lt;/p&gt;
&lt;div class="admonition note"&gt;
&lt;p class="admonition-title"&gt;Note&lt;/p&gt;
&lt;p&gt;There is a &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;use-simple&lt;/span&gt;&lt;/code&gt; setting for the &lt;strong class="command"&gt;bzr&lt;/strong&gt; support that may
make the &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;vcs_info&lt;/span&gt;&lt;/code&gt; functionality faster for you, albeit not noticeably on
my system.  It is also the only &lt;abbr title="Version Control System"&gt;VCS&lt;/abbr&gt; that has such a hack, which is quite
telling in itself.&lt;/p&gt;
&lt;/div&gt;
&lt;/section&gt;
&lt;section id="repository-state"&gt;
&lt;h2&gt;Repository state&lt;/h2&gt;
&lt;p&gt;The “funky arrows” Dan asks about are dependent on the state of the current
working directory as can be seen in the screenshot at the top of this page.&lt;/p&gt;
&lt;table class="docutils align-default"&gt;
&lt;colgroup&gt;
&lt;col style="width: 20%" /&gt;
&lt;col style="width: 80%" /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class="row-odd"&gt;&lt;th class="head"&gt;&lt;p&gt;Identifier&lt;/p&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;p&gt;Description&lt;/p&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class="row-even"&gt;&lt;td&gt;&lt;p&gt;white →&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Not a &lt;strong class="command"&gt;git&lt;/strong&gt; repository&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class="row-odd"&gt;&lt;td&gt;&lt;p&gt;green ▶&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Clean &lt;strong class="command"&gt;git&lt;/strong&gt; repository&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class="row-even"&gt;&lt;td&gt;&lt;p&gt;red ▶&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Staged changes in &lt;strong class="command"&gt;git&lt;/strong&gt; repository&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class="row-odd"&gt;&lt;td&gt;&lt;p&gt;yellow ▶&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Unstaged changes in &lt;strong class="command"&gt;git&lt;/strong&gt; repository&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Using these visual markers it is always obvious what state a directory is in,
I’ve toyed with adding more but suspect the lack of complexity is what makes
them so useful.&lt;/p&gt;
&lt;p&gt;To enable them we need to add a &lt;a class="reference external" href="http://zsh.sourceforge.net/Doc/Release/Functions.html#SEC45"&gt;precmd hook&lt;/a&gt; to calculate the repository
status:&lt;/p&gt;
&lt;div class="highlight-zsh notranslate"&gt;&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;autoload -U add-zsh-hook
add-zsh-hook precmd prompt_jnrowe_precmd

prompt_jnrowe_precmd &lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
    vcs_info

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -z &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;vcs_info_msg_0_&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="nv"&gt;dir_status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;%F{2}→%f&amp;quot;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; -n &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;git diff --cached --name-status &lt;span class="m"&gt;2&lt;/span&gt;&amp;gt;/dev/null &lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]]&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="nv"&gt;dir_status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;%F{1}▶%f&amp;quot;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; -n &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="k"&gt;$(&lt;/span&gt;git diff --name-status &lt;span class="m"&gt;2&lt;/span&gt;&amp;gt;/dev/null &lt;span class="k"&gt;)&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]]&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="nv"&gt;dir_status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;%F{3}▶%f&amp;quot;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;
        &lt;span class="nv"&gt;dir_status&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;%F{2}▶%f&amp;quot;&lt;/span&gt;
    &lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;With this added the we just need to include &lt;span class="target" id="index-1"&gt;&lt;/span&gt;&lt;code class="xref std std-envvar docutils literal notranslate"&gt;&lt;span class="pre"&gt;$dir_status&lt;/span&gt;&lt;/code&gt; in our prompt
and the status identifiers will be used.&lt;/p&gt;
&lt;p&gt;If you are using a font which doesn’t display the characters correctly, either
change the characters in the &lt;code class="docutils literal notranslate"&gt;&lt;span class="pre"&gt;dir_status&lt;/span&gt;&lt;/code&gt; values or switch to a &lt;a class="reference external" href="http://www.is-vn.bg/hamster/"&gt;better font&lt;/a&gt;
that can display them.&lt;/p&gt;
&lt;/section&gt;
&lt;/section&gt;
</content>
    <link href="https://jnrowe.github.io/articles/tips/Zsh_and_the_vcs.html" rel="alternate"/>
    <summary>I’ve recently switched to Zsh as my login shell after
9 years of using bash, and for no particularly good reason either as they’re
both great interactive shells.  I guess all the Kool Kids are doing it, and
I’m just playing catchup.  The one side effect of that is I’m now scribbling
tips about zsh too…</summary>
    <category term="git" label="git"/>
    <category term="vcs" label="vcs"/>
    <category term="zsh" label="zsh"/>
    <published>2009-10-28T00:00:00+00:00</published>
  </entry>
</feed>
